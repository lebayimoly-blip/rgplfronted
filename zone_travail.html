<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#0d6efd">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="static/icons/icon-192.png">
  <link rel="stylesheet" href="static/style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
  <title>DÃ©finir une zone de travail</title>
</head>
<body>
  <main>
    <h2>ğŸ—ºï¸ DÃ©finir une zone de travail</h2>
    <p>Tracez une zone sur la carte, puis cliquez sur "Valider la zone".</p>

    <div id="map" style="height: 500px; width: 100%; margin-bottom: 20px;"></div>
    <button onclick="validerZone()">âœ… Valider la zone</button>
    <p id="confirmation" style="color: green; font-weight: bold; margin-top: 15px;"></p>

    <div id="selectionUtilisateur" style="display: none; margin-top: 20px;">
      <label for="utilisateur">ğŸ‘¤ SÃ©lectionner un utilisateur :</label>
      <input type="text" id="rechercheUtilisateur" placeholder="Rechercher un nom..." onkeyup="rechercherUtilisateurs()" style="margin-bottom: 10px; width: 100%; padding: 5px;" />
      <select id="utilisateur" size="8" style="width: 100%; padding: 5px;"></select>
      <button onclick="attribuerZone()">ğŸ“ Attribuer la zone</button>
    </div>

    <a href="/zones-attribuees">
      <button style="margin-top: 20px;">ğŸ“„ Voir les zones attribuÃ©es</button>
    </a>
  </main>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
  <script>
    let map;
    let drawnItems;

    function initMap() {
      map = L.map('map').setView([0.39, 9.45], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(map);

      drawnItems = new L.FeatureGroup();
      map.addLayer(drawnItems);

      const drawControl = new L.Control.Draw({
        draw: {
          polygon: true,
          polyline: false,
          rectangle: false,
          circle: false,
          marker: false,
          circlemarker: false
        },
        edit: {
          featureGroup: drawnItems
        }
      });
      map.addControl(drawControl);

      map.on(L.Draw.Event.CREATED, function (e) {
        drawnItems.clearLayers();
        drawnItems.addLayer(e.layer);
      });
    }

    function validerZone() {
      if (drawnItems.getLayers().length === 0) {
        alert("Veuillez tracer une zone d'abord.");
      } else {
        document.getElementById("confirmation").innerText = "Zone validÃ©e âœ…";
        document.getElementById("selectionUtilisateur").style.display = "block";
      }
    }

    function rechercherUtilisateurs() {
      const query = document.getElementById("rechercheUtilisateur").value.trim();
      const select = document.getElementById("utilisateur");
      select.innerHTML = "";

      if (query.length === 0) return;

      fetch(`/api/recherche-utilisateur?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
          data.forEach(u => {
            const option = document.createElement("option");
            option.value = u.id;
            option.textContent = `${u.nom} (${u.role})`;
            select.appendChild(option);
          });
        })
        .catch(error => {
          console.error("Erreur lors de la recherche :", error);
        });
    }

    function attribuerZone() {
      const id = document.getElementById("utilisateur").value;
      if (!id) {
        alert("Veuillez sÃ©lectionner un utilisateur.");
        return;
      }

      const layer = drawnItems.getLayers()[0];
      if (!layer) {
        alert("Aucune zone dessinÃ©e.");
        return;
      }

      const geojson = layer.toGeoJSON();

      fetch("/api/attribuer-zone", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          utilisateur_id: parseInt(id),
          geojson: geojson
        })
      })
      .then(response => response.json())
      .then(data => {
        alert(data.message || "Zone attribuÃ©e !");
      })
      .catch(error => {
        console.error("Erreur lors de l'attribution :", error);
        alert("Erreur lors de l'attribution de la zone.");
      });
    }

    window.onload = initMap;
  </script>
</body>
<!-- Scripts JS -->
  <script src="static/js/db.js"></script>
  <script src="static/js/main.js"></script>
  <script src="static/js/sw-register.js"></script>
</html>
